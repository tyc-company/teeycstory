<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>æ•…äº‹ç½‘ç«™</title>
<style>
body {
  font-family: "å¾®è½¯é›…é»‘", sans-serif;
  background: linear-gradient(120deg, #fdfbfb, #ebedee);
  padding: 20px;
}

h1 {
  text-align: center;
  color: #333;
}

textarea {
  width: 100%;
  height: 120px;
  padding: 10px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

button {
  margin-top: 10px;
  padding: 8px 14px;
  font-size: 14px;
  border: none;
  border-radius: 8px;
  background: #4caf50;
  color: white;
  cursor: pointer;
}

button:hover {
  background: #43a047;
}

.story {
  background: white;
  border-radius: 12px;
  padding: 12px;
  margin-top: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.story button {
  background: #2196f3;
  margin-right: 6px;
}

.story button:last-child {
  background: #f44336;
}
</style>
  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body><div id="loginBox">
  <h2>ğŸ” ç™»å½•</h2>
  <p>ç”¨æˆ·åï¼š</p>
  <input id="username" placeholder="ä½ çš„åå­—"><br><br>
  <p>å¯†ç ï¼š</p>
  <input id="password" type="password"><br><br>
  <button onclick="login()">ç™»å½•</button>
  <button onclick="register()">æ³¨å†Œ</button>
  
</div>

<div id="siteBox" style="display:none;">

<h1>ğŸ“– æ•…äº‹ç½‘ç«™</h1>

<p>åœ¨ä¸‹é¢å†™ä¸‹ä½ çš„æ•…äº‹ï¼š</p>

<textarea id="storyInput" placeholder="ä»å‰ä»å‰â€¦â€¦"></textarea><br><br>

<button onclick="addStory()">å‘å¸ƒæ•…äº‹</button>

<h2>ğŸ§¾ æ•…äº‹åˆ—è¡¨</h2>
<div id="storyList"></div>

<script>
const supabaseUrl = "https://fyykdxogvqrusllwgtth.supabase.co";
const supabaseKey = "sb_publishable_7otnfU5jy4Nus66IyPRj0g_-vImZ0uX";

const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

// ===== ç™»å½• =====
async function login() {
  const email = document.getElementById("username").value + "@story.com";
  const password = document.getElementById("password").value;

  const { error } = await sb.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert("ç™»å½•å¤±è´¥ï¼Œå¯èƒ½è¿˜æ²¡æ³¨å†Œ");
  } else {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("siteBox").style.display = "block";
    loadStories();
  }
}

// ===== æ³¨å†Œ =====
async function register() {
  const email = document.getElementById("username").value + "@story.com";
  const password = document.getElementById("password").value;

  const { error } = await sb.auth.signUp({
    email,
    password
  });

  if (error) {
    alert(error.message);
  } else {
    alert("æ³¨å†ŒæˆåŠŸï¼ç°åœ¨å¯ä»¥ç™»å½•äº†");
  }
}

// ===== åŠ è½½æ•…äº‹ =====
async function loadStories() {
  const { data: stories } = await sb
    .from("stories")
    .select("*")
    .order("created_at", { ascending: false });

  const list = document.getElementById("storyList");
  list.innerHTML = "";

  for (const story of stories) {
    const div = document.createElement("div");
    div.className = "story";

    // æ•…äº‹å†…å®¹
    const content = document.createElement("p");
    content.innerText = "ğŸ“– " + story.content;
    div.appendChild(content);

    // è¯„è®ºåˆ—è¡¨
    const commentsBox = document.createElement("div");
    commentsBox.style.marginTop = "10px";

    const { data: comments } = await sb
      .from("comments")
      .select("*")
      .eq("story_id", story.id)
      .order("created_at");

    comments.forEach(c => {
      const p = document.createElement("p");
      p.innerText = "ğŸ’¬ " + c.author + "ï¼š" + c.content;
      p.style.fontSize = "14px";
      commentsBox.appendChild(p);
    });

    div.appendChild(commentsBox);

    // è¯„è®ºè¾“å…¥æ¡†
    const input = document.createElement("input");
    input.placeholder = "å†™è¯„è®ºâ€¦";
    input.style.width = "80%";

    const btn = document.createElement("button");
    btn.innerText = "å‘è¡¨è¯„è®º";
    btn.onclick = () => addComment(story.id, input.value);

    div.appendChild(input);
    div.appendChild(btn);

    list.appendChild(div);
  }
}

// ===== å‘å¸ƒæ•…äº‹ =====
async function addStory() {
  const text = document.getElementById("storyInput").value;
  if (text === "") {
    alert("è¦å…ˆå†™æ•…äº‹å“¦ï¼");
    return;
  }

  const user = await sb.auth.getUser();
  const name = user.data.user.email.split("@")[0];

  await sb.from("stories").insert({
    author: name,
    content: text,
    hidden: false
  });

  document.getElementById("storyInput").value = "";
  loadStories();
}
  async function addComment(storyId, text) {
  if (text === "") {
    alert("è¯„è®ºä¸èƒ½ä¸ºç©º");
    return;
  }
  const user = await sb.auth.getUser();
  const name = user.data.user.email.split("@")[0];

  await sb.from("comments").insert({
    story_id: storyId,
    author: name,
    content: text
  });

  loadStories();
}

</script>




</body>
</html>
